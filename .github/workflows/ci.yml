name: CI

on:
  push:
    branches: [ main ]
    tags: [ "*" ]
  pull_request:
    branches: [ main ]

env:
  IMAGE_NAME: aero-hand-jax
  CUDA_VERSION: 12.4.1
  MUJOCO_PLAYGROUND_REF: main

jobs:
  build:
    runs-on: ubuntu-22.04
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Compute image tag
        id: vars
        env:
          GITHUB_EVENT_NAME: ${{ github.event_name }}
          GITHUB_HEAD_REF: ${{ github.head_ref }}
          GITHUB_REF: ${{ github.ref }}
        run: |
          if [[ "${GITHUB_EVENT_NAME}" == "pull_request" ]]; then
            ref="${GITHUB_HEAD_REF}"
          elif [[ "${GITHUB_REF}" == refs/heads/* ]]; then
            ref="${GITHUB_REF#refs/heads/}"
          elif [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            ref="${GITHUB_REF#refs/tags/}"
          else
            ref="${GITHUB_REF}"
          fi

          # Docker tag must match [a-z0-9_.-]; normalize branch/tag names.
          normalized_ref="$(echo "${ref}" | tr '[:upper:]' '[:lower:]' | sed 's#[^a-z0-9._-]#-#g')"

          if [[ "${ref}" == "main" ]]; then
            tag="latest"
          else
            tag="${normalized_ref}"
          fi

          if [[ "${GITHUB_EVENT_NAME}" == "push" && ( "${GITHUB_REF}" == "refs/heads/main" || "${GITHUB_REF}" == refs/tags/* ) ]]; then
            do_push=true
          else
            do_push=false
          fi

          echo "ref=${ref}" >> "$GITHUB_OUTPUT"
          echo "tag=${tag}" >> "$GITHUB_OUTPUT"
          echo "do_push=${do_push}" >> "$GITHUB_OUTPUT"

      - name: Log in to GHCR
        if: steps.vars.outputs.do_push == 'true'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build image (push on main/tags)
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          push: ${{ steps.vars.outputs.do_push == 'true' }}
          tags: |
            ghcr.io/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:${{ steps.vars.outputs.tag }}
          build-args: |
            CUDA_VERSION=${{ env.CUDA_VERSION }}
            MUJOCO_PLAYGROUND_REF=${{ env.MUJOCO_PLAYGROUND_REF }}

      - name: Summary
        if: always()
        run: |
          echo "Image: ghcr.io/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:${{ steps.vars.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "Ref: ${{ steps.vars.outputs.ref }}" >> $GITHUB_STEP_SUMMARY
          echo "Pushed: ${{ steps.vars.outputs.do_push }}" >> $GITHUB_STEP_SUMMARY
